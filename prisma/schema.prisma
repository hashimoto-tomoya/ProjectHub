// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TBL-001: users（ユーザー）
// =============================================================================
model User {
  id           BigInt    @id @default(autoincrement())
  name         String    @db.VarChar(100)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         String    @db.VarChar(20) // admin / pmo / pm / developer
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  createdProjects    Project[]       @relation("CreatedProjects")
  projectMemberships ProjectMember[]
  assignedTasks      Task[]          @relation("AssignedTasks")
  dailyReports       DailyReport[]
  reviewedSessions   ReviewSession[] @relation("ReviewerSessions")
  createdSessions    ReviewSession[] @relation("CreatedSessions")
  assignedReviews    ReviewItem[]    @relation("AssignedReviewItems")
  assignedBugs       Bug[]           @relation("AssignedBugs")
  createdBugs        Bug[]           @relation("CreatedBugs")
  auditLogs          AuditLog[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

// =============================================================================
// TBL-002: projects（プロジェクト）
// =============================================================================
model Project {
  id          BigInt    @id @default(autoincrement())
  name        String    @db.VarChar(200)
  description String?   @db.Text
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date
  status      String    @default("active") @db.VarChar(20) // active / archived
  bugSequence Int       @default(0) @map("bug_sequence")
  createdBy   BigInt    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  creator          User               @relation("CreatedProjects", fields: [createdBy], references: [id])
  members          ProjectMember[]
  tasks            Task[]
  reviewSessions   ReviewSession[]
  reviewCategories ReviewCategory[]
  bugs             Bug[]

  @@index([status])
  @@map("projects")
}

// =============================================================================
// TBL-003: project_members（プロジェクトメンバー）
// T03-2: is_favorite カラム追加（API設計書の追記事項対応）
// =============================================================================
model ProjectMember {
  id         BigInt   @id @default(autoincrement())
  projectId  BigInt   @map("project_id")
  userId     BigInt   @map("user_id")
  isFavorite Boolean  @default(false) @map("is_favorite")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@unique([projectId, userId])
  @@map("project_members")
}

// =============================================================================
// TBL-004: tasks（タスク・WBS）
// =============================================================================
model Task {
  id           BigInt    @id @default(autoincrement())
  projectId    BigInt    @map("project_id")
  parentTaskId BigInt?   @map("parent_task_id")
  level        Int       @db.SmallInt // 1=大項目 / 2=中項目 / 3=小項目
  name         String    @db.VarChar(300)
  assigneeId   BigInt?   @map("assignee_id")
  startDate    DateTime  @map("start_date") @db.Date
  endDate      DateTime  @map("end_date") @db.Date
  plannedHours Decimal   @default(0) @map("planned_hours") @db.Decimal(8, 2)
  status       String    @default("未着手") @db.VarChar(20) // 未着手 / 進行中 / 完了 / 保留
  sortOrder    Int       @default(0) @map("sort_order")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentTask   Task?                @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: Restrict)
  childTasks   Task[]               @relation("TaskHierarchy")
  assignee     User?                @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)
  reportEntries DailyReportEntry[]
  bugs         Bug[]

  @@index([projectId, status])
  @@index([parentTaskId])
  @@index([assigneeId])
  @@index([status])
  @@map("tasks")
}

// =============================================================================
// TBL-005: daily_reports（日報ヘッダー）
// =============================================================================
model DailyReport {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @map("user_id")
  workDate  DateTime @map("work_date") @db.Date
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  entries DailyReportEntry[]

  @@unique([userId, workDate])
  @@index([workDate])
  @@map("daily_reports")
}

// =============================================================================
// TBL-006: daily_report_entries（日報明細）
// =============================================================================
model DailyReportEntry {
  id            BigInt   @id @default(autoincrement())
  dailyReportId BigInt   @map("daily_report_id")
  taskId        BigInt   @map("task_id")
  workHours     Decimal  @map("work_hours") @db.Decimal(5, 2)
  comment       String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  task        Task        @relation(fields: [taskId], references: [id], onDelete: Restrict)

  @@index([dailyReportId])
  @@index([taskId])
  @@map("daily_report_entries")
}

// =============================================================================
// TBL-007: review_sessions（レビューセッション）
// =============================================================================
model ReviewSession {
  id          BigInt   @id @default(autoincrement())
  projectId   BigInt   @map("project_id")
  reviewType  String   @map("review_type") @db.VarChar(50)
  targetName  String   @map("target_name") @db.VarChar(300)
  sessionDate DateTime @map("session_date") @db.Date
  reviewerId  BigInt   @map("reviewer_id")
  createdBy   BigInt   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer    User         @relation("ReviewerSessions", fields: [reviewerId], references: [id], onDelete: Restrict)
  creator     User         @relation("CreatedSessions", fields: [createdBy], references: [id], onDelete: Restrict)
  reviewItems ReviewItem[]

  @@index([projectId])
  @@index([sessionDate])
  @@map("review_sessions")
}

// =============================================================================
// TBL-008: review_categories（指摘区分マスタ）
// =============================================================================
model ReviewCategory {
  id        BigInt   @id @default(autoincrement())
  projectId BigInt   @map("project_id")
  name      String   @db.VarChar(100)
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewItems ReviewItem[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("review_categories")
}

// =============================================================================
// TBL-009: review_items（レビュー指摘事項）
// =============================================================================
model ReviewItem {
  id              BigInt    @id @default(autoincrement())
  reviewSessionId BigInt    @map("review_session_id")
  categoryId      BigInt?   @map("category_id")
  content         String    @db.Text
  severity        String?   @db.VarChar(20) // 致命的 / 高 / 中 / 低
  assigneeId      BigInt?   @map("assignee_id")
  status          String    @default("未対応") @db.VarChar(20) // 未対応 / 修正中 / 確認待ち / 完了
  resolvedDate    DateTime? @map("resolved_date") @db.Date
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  reviewSession ReviewSession   @relation(fields: [reviewSessionId], references: [id], onDelete: Cascade)
  category      ReviewCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  assignee      User?           @relation("AssignedReviewItems", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([reviewSessionId, categoryId])
  @@index([status])
  @@index([assigneeId])
  @@map("review_items")
}

// =============================================================================
// TBL-010: bugs（障害管理票）
// =============================================================================
model Bug {
  id                BigInt    @id @default(autoincrement())
  projectId         BigInt    @map("project_id")
  bugNumber         String    @map("bug_number") @db.VarChar(20) // BUG-001 形式
  title             String    @db.VarChar(300)
  description       String?   @db.Text
  foundDate         DateTime  @map("found_date") @db.Date
  foundPhase        String    @map("found_phase") @db.VarChar(50)
  severity          String    @db.VarChar(20) // 致命的 / 高 / 中 / 低
  status            String    @default("未対応") @db.VarChar(20) // 未対応 / 調査中 / 修正中 / 確認待ち / クローズ
  assigneeId        BigInt?   @map("assignee_id")
  taskId            BigInt?   @map("task_id")
  stepsToReproduce  String?   @map("steps_to_reproduce") @db.Text
  rootCause         String?   @map("root_cause") @db.Text
  fixDescription    String?   @map("fix_description") @db.Text
  resolvedDate      DateTime? @map("resolved_date") @db.Date
  createdBy         BigInt    @map("created_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee User?   @relation("AssignedBugs", fields: [assigneeId], references: [id], onDelete: SetNull)
  task     Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)
  creator  User    @relation("CreatedBugs", fields: [createdBy], references: [id], onDelete: Restrict)

  @@unique([projectId, bugNumber])
  @@index([projectId, status])
  @@index([projectId, foundDate])
  @@index([projectId, resolvedDate])
  @@index([status])
  @@index([severity])
  @@index([assigneeId])
  @@index([taskId])
  @@index([projectId, assigneeId, severity])
  @@map("bugs")
}

// =============================================================================
// T03-3: audit_logs（操作ログ）
// =============================================================================
model AuditLog {
  id           BigInt   @id @default(autoincrement())
  timestamp    DateTime @default(now())
  userId       BigInt?  @map("user_id")
  action       String   @db.VarChar(50) // CREATE / UPDATE / DELETE 等
  resourceType String   @map("resource_type") @db.VarChar(50) // User / Project / Task 等
  resourceId   BigInt?  @map("resource_id")
  detail       String?  @db.Text

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
  @@map("audit_logs")
}
