# テスト設計

## テスト戦略

### テスト方針

テストピラミッドに基づき、単体テストを中心に結合テスト・E2E テストを組み合わせる。

```
      ┌──────────────┐
      │   E2E (5件)   │  ← 主要業務シナリオのみ
      ├──────────────┤
      │ Integration  │  ← 全APIエンドポイント・認証認可
      │  (30件程度)  │
      ├──────────────┤
      │ Unit Tests   │  ← サービス層・バリデーション・ユーティリティ
      │  (60件程度)  │
      └──────────────┘
```

| テストレベル | 目的 | 主な対象 | 実行タイミング |
|-------------|------|---------|--------------|
| 単体テスト | ビジネスロジック・バリデーションの正確性検証 | サービス層・ユーティリティ | コミット時（pre-commit hook） |
| 結合テスト | API エンドポイント・DB 連携の正確性検証 | Next.js API Routes → Prisma → テスト DB | PR 作成時（CI） |
| E2E テスト | 主要業務シナリオの動作検証 | ブラウザ操作 → API → DB 一連フロー | デプロイ前（CI） |

### テストツール

| カテゴリ | ツール | バージョン | 用途 |
|---------|-------|-----------|------|
| テストランナー | Vitest | 1.x | 単体・結合テスト実行 |
| アサーション | Vitest (`expect`) | — | 期待値検証 |
| FE コンポーネントテスト | Testing Library (`@testing-library/react`) | 14.x | コンポーネント描画・イベント検証 |
| モック（BE） | Vitest `vi.mock()` | — | サービス・リポジトリのモック化 |
| モック（FE） | MSW (Mock Service Worker) | 2.x | API リクエストのモック化 |
| E2E テスト | Playwright | 1.x | ブラウザ操作テスト |
| カバレッジ | `@vitest/coverage-v8` | — | カバレッジ計測・レポート |

### カバレッジ目標

| テストレベル | 対象 | 目標 | 備考 |
|-------------|------|------|------|
| 単体テスト | サービス層 | 80%以上 | ビジネスロジックの中核 |
| 単体テスト | ユーティリティ（バリデーション・エラーハンドラ） | 90%以上 | 共通処理の品質確保 |
| 結合テスト | API エンドポイント | 全エンドポイントの正常系・主要異常系 | 認証・認可を含む |
| E2E テスト | 主要業務フロー | 5シナリオ | ビジネスインパクトの高いフローに集中 |

### テスト環境

| 項目 | 方針 |
|------|------|
| テスト用 DB | Docker Compose の `test` プロファイルで起動する PostgreSQL 専用コンテナ（本番と分離） |
| DB セットアップ | テスト実行前に `prisma migrate reset --force` でクリーン DB を構築 |
| テスト間分離 | 各テストファイル実行後にテーブルをトランケート（`beforeEach` でシードデータを再投入） |
| 外部依存 | 外部サービスなし（本システムは外部連携なし）。NextAuth.js のセッション検証はモック化 |
| CI/CD | GitHub Actions で PR 時に単体・結合テストを実行。E2E はデプロイ前の自動実行 |

```yaml
# テスト実行コマンド
npm run test          # 単体テスト（Vitest）
npm run test:int      # 結合テスト（Vitest + テスト DB）
npm run test:e2e      # E2E テスト（Playwright）
npm run test:cov      # カバレッジレポート生成
```

---

## 主要テストケース

### 単体テスト

#### SVC-003: TaskService — 階層制限・バリデーション

| TC-ID | テスト対象 | テスト内容 | 前提条件 | 期待結果 | 区分 |
|-------|-----------|-----------|---------|---------|------|
| TC-UT-001 | `TaskService.create` | 正常なタスク登録（大項目） | `parentTaskId = null` | Task が作成される（`level = 1`） | 正常系 |
| TC-UT-002 | `TaskService.create` | 中項目タスクの登録 | 大項目タスクが存在 | Task が作成される（`level = 2`） | 正常系 |
| TC-UT-003 | `TaskService.create` | 階層 3 レベル超過 | 小項目タスク（level=3）を親に指定 | 422 `INVALID_HIERARCHY` エラー | 異常系 |
| TC-UT-004 | `TaskService.create` | 終了日が開始日より前 | `startDate > endDate` | 400 `VALIDATION_ERROR` エラー | 異常系 |
| TC-UT-005 | `TaskService.update` | ガントチャート D&D での期間更新 | 既存タスクが存在 | `startDate` / `endDate` が更新される | 正常系 |

#### SVC-004: DailyReportService — 日報登録・重複チェック

| TC-ID | テスト対象 | テスト内容 | 前提条件 | 期待結果 | 区分 |
|-------|-----------|-----------|---------|---------|------|
| TC-UT-006 | `DailyReportService.create` | 正常な日報登録（複数タスク） | 当日以前の日付 | `daily_reports` + `daily_report_entries` が作成される | 正常系 |
| TC-UT-007 | `DailyReportService.create` | 将来日の日報登録 | `workDate` が翌日以降 | 400 `VALIDATION_ERROR` エラー | 異常系 |
| TC-UT-008 | `DailyReportService.create` | 同一日付の重複登録 | 同日の日報が既に存在 | 409 `CONFLICT` エラー | 異常系 |
| TC-UT-009 | `DailyReportService.create` | 作業時間が 0 | `workHours = 0` | 400 `VALIDATION_ERROR` エラー | 異常系 |

#### SVC-006: BugService — 障害番号採番・ステータス遷移

| TC-ID | テスト対象 | テスト内容 | 前提条件 | 期待結果 | 区分 |
|-------|-----------|-----------|---------|---------|------|
| TC-UT-010 | `BugService.create` | 障害番号の採番（初回） | `projects.bug_sequence = 0` | `bugNumber = "BUG-001"`、`bug_sequence = 1` に更新 | 正常系 |
| TC-UT-011 | `BugService.create` | 障害番号の採番（連番） | `projects.bug_sequence = 5` | `bugNumber = "BUG-006"` | 正常系 |
| TC-UT-012 | `BugService.update` | 正常なステータス遷移（未対応→調査中） | `status = '未対応'` | `status = '調査中'` に更新 | 正常系 |
| TC-UT-013 | `BugService.update` | 不正なステータス遷移（未対応→クローズ） | `status = '未対応'` | 422 `INVALID_TRANSITION` エラー | 異常系 |

#### SVC-005: ReviewService — 指摘ステータス遷移

| TC-ID | テスト対象 | テスト内容 | 前提条件 | 期待結果 | 区分 |
|-------|-----------|-----------|---------|---------|------|
| TC-UT-014 | `ReviewService.updateItem` | 差し戻し遷移（確認待ち→修正中） | `status = '確認待ち'` | `status = '修正中'` に更新 | 正常系 |
| TC-UT-015 | `ReviewService.updateItem` | 不正な遷移（未対応→完了） | `status = '未対応'` | 422 `INVALID_TRANSITION` エラー | 異常系 |

#### ユーティリティ — パスワードバリデーション・エラーハンドラ

| TC-ID | テスト対象 | テスト内容 | 入力 | 期待結果 | 区分 |
|-------|-----------|-----------|-----|---------|------|
| TC-UT-016 | `validatePassword` | 有効なパスワード | `"Abc12345"` | バリデーション通過 | 正常系 |
| TC-UT-017 | `validatePassword` | 7文字（最小未満） | `"Abc1234"` | バリデーションエラー | 異常系 |
| TC-UT-018 | `validatePassword` | 数字のみ | `"12345678"` | バリデーションエラー（英字必須） | 異常系 |
| TC-UT-019 | `handleApiError` | `ZodError` を HTTP 400 に変換 | `ZodError` | `{ status: 400, body: { error: { code: "VALIDATION_ERROR" } } }` | 正常系 |
| TC-UT-020 | `handleApiError` | `NotFoundError` を HTTP 404 に変換 | `NotFoundError` | `{ status: 404, body: { error: { code: "NOT_FOUND" } } }` | 正常系 |

---

### 結合テスト

#### 認証・認可

| TC-ID | 対象API | メソッド | パス | テスト内容 | 期待結果 | 区分 |
|-------|---------|---------|------|-----------|---------|------|
| TC-IT-001 | — | POST | `/api/auth/signin` | 正しい認証情報でログイン | セッション Cookie が発行される（200） | 正常系 |
| TC-IT-002 | — | POST | `/api/auth/signin` | 誤パスワードでログイン | 認証エラー（401） | 異常系 |
| TC-IT-003 | API-C-002 | GET | `/api/projects` | 未認証でアクセス | 401 `UNAUTHORIZED` | 異常系 |
| TC-IT-004 | API-A-001 | GET | `/api/admin/users` | PM ロールでアクセス | 403 `FORBIDDEN` | 異常系 |
| TC-IT-005 | API-C-001 | PUT | `/api/users/me/password` | 正しい現パスワードで変更 | 204（パスワード更新成功） | 正常系 |

#### プロジェクト・WBS

| TC-ID | 対象API | メソッド | パス | テスト内容 | 期待結果 | 区分 |
|-------|---------|---------|------|-----------|---------|------|
| TC-IT-006 | API-C-002 | GET | `/api/projects` | PM ロールでプロジェクト一覧取得 | 参加プロジェクト一覧が返る（200） | 正常系 |
| TC-IT-007 | API-C-011 | POST | `/api/projects/{id}/tasks` | PM が大項目タスクを登録 | Task が作成され 201 | 正常系 |
| TC-IT-008 | API-C-011 | POST | `/api/projects/{id}/tasks` | 開発者がタスクを登録 | 403 `FORBIDDEN` | 異常系 |
| TC-IT-009 | API-C-011 | POST | `/api/projects/{id}/tasks` | 階層 4 レベルのタスクを登録 | 422 `INVALID_HIERARCHY` | 異常系 |
| TC-IT-010 | API-C-010 | GET | `/api/projects/{id}/tasks` | タスク一覧取得（実績工数付き） | `actualHours` が日報集計値で返る（200） | 正常系 |

#### 日報

| TC-ID | 対象API | メソッド | パス | テスト内容 | 期待結果 | 区分 |
|-------|---------|---------|------|-----------|---------|------|
| TC-IT-011 | API-C-015 | POST | `/api/projects/{id}/daily-reports` | 開発者が複数タスクの日報を登録 | `daily_reports` + `daily_report_entries` が DB に作成（201） | 正常系 |
| TC-IT-012 | API-C-015 | POST | `/api/projects/{id}/daily-reports` | 同一日付の重複登録 | 409 `CONFLICT` | 異常系 |
| TC-IT-013 | API-C-015 | POST | `/api/projects/{id}/daily-reports` | PMO が日報登録を試みる | 403 `FORBIDDEN` | 異常系 |
| TC-IT-014 | API-C-014 | GET | `/api/projects/{id}/daily-reports` | カレンダービュー用の月次データ取得 | 指定期間の日報一覧が返る（200） | 正常系 |

#### 障害・レビュー指摘

| TC-ID | 対象API | メソッド | パス | テスト内容 | 期待結果 | 区分 |
|-------|---------|---------|------|-----------|---------|------|
| TC-IT-015 | API-C-025 | POST | `/api/projects/{id}/bugs` | 障害登録（`bug_sequence` インクリメント） | `bugNumber = "BUG-001"` で登録（201）、`projects.bug_sequence = 1` | 正常系 |
| TC-IT-016 | API-C-027 | PUT | `/api/projects/{id}/bugs/{bugId}` | 不正なステータス遷移 | 422 `INVALID_TRANSITION` | 異常系 |
| TC-IT-017 | API-C-022 | PUT | `/api/projects/{id}/review-items/{itemId}` | 差し戻し遷移（確認待ち→修正中） | 指摘ステータスが `修正中` に更新（200） | 正常系 |

#### レポート

| TC-ID | 対象API | メソッド | パス | テスト内容 | 期待結果 | 区分 |
|-------|---------|---------|------|-----------|---------|------|
| TC-IT-018 | API-C-029 | GET | `/api/projects/{id}/reports/evm` | EVM データ取得 | PV/AC/EV の日次配列と summary（SPI/CPI/残工数）が返る（200） | 正常系 |
| TC-IT-019 | API-C-028 | GET | `/api/projects/{id}/dashboard` | ダッシュボード集計データ取得 | 全指標が正しく計算されて返る（200） | 正常系 |

---

### E2E テスト

#### 対象シナリオ

主要業務フロー 5 シナリオを E2E テストで検証する。

| シナリオID | シナリオ名 | 対応機能要件 | 優先度 |
|-----------|-----------|------------|-------|
| TC-E2E-001 | ログイン → ダッシュボード表示 | FR-AUTH-001, FR-REPORT-005 | 高 |
| TC-E2E-002 | WBS タスク登録 → 一覧確認 | FR-WBS-001, FR-WBS-003 | 高 |
| TC-E2E-003 | 日報入力 → WBS 実績工数への自動反映確認 | FR-DAILY-001, FR-WBS-004 | 高 |
| TC-E2E-004 | 障害登録 → ステータス更新フロー | FR-BUG-001, FR-BUG-002 | 中 |
| TC-E2E-005 | レポート画面（EVM グラフ）表示 | FR-REPORT-001 | 中 |

#### TC-E2E-001: ログイン → ダッシュボード表示

**前提条件:** テストユーザー（PM ロール）が登録済み

| ステップ | 操作 | 画面 | 検証項目 |
|---------|------|------|---------|
| 1 | `/login` にアクセス | SCR-C-001 ログイン | ログインフォームが表示される |
| 2 | メールアドレス・パスワードを入力してログインボタンクリック | SCR-C-001 | — |
| 3 | プロジェクト一覧ページにリダイレクト | SCR-C-002 | `ProjectListPage` が表示される |
| 4 | プロジェクト行をクリック | SCR-C-002 | — |
| 5 | ダッシュボードに遷移 | SCR-C-003 | SPI / CPI / 障害数 / 指摘数 のカードが表示される |

#### TC-E2E-002: WBS タスク登録 → 一覧確認

**前提条件:** PM ロールでログイン済み、プロジェクトが 1 件存在

| ステップ | 操作 | 画面 | 検証項目 |
|---------|------|------|---------|
| 1 | サイドバーの「WBS・タスク管理」をクリック | SCR-C-004 | WBS ツリーテーブルが表示される |
| 2 | 「+ タスク追加」ボタンをクリック | SCR-C-004 | TaskSlideOver が開く |
| 3 | タスク名・担当者・開始日・終了日・予定工数を入力して「保存」 | SCR-C-004 | — |
| 4 | スライドオーバーが閉じる | SCR-C-004 | 登録したタスクが WBS ツリーに追加表示される |
| 5 | 予定工数が正しく表示されることを確認 | SCR-C-004 | `plannedHours` が入力値と一致する |

#### TC-E2E-003: 日報入力 → WBS 実績工数反映確認

**前提条件:** 開発者ロールでログイン済み、WBS タスクが 1 件存在

| ステップ | 操作 | 画面 | 検証項目 |
|---------|------|------|---------|
| 1 | 「日報入力・管理」を開く | SCR-C-005 | 日報カレンダービューが表示される |
| 2 | 「+ 日報入力」ボタンをクリック | SCR-C-005 | DailyReportSlideOver が開く |
| 3 | 当日の日付・タスク（プルダウン選択）・作業時間 4h を入力して「保存」 | SCR-C-005 | — |
| 4 | カレンダーの当日セルに「✓」が表示されることを確認 | SCR-C-005 | 入力済みマークが表示される |
| 5 | 「WBS・タスク管理」に遷移 | SCR-C-004 | WBS ツリーテーブルが表示される |
| 6 | 対象タスクの実績工数が 4h に更新されていることを確認 | SCR-C-004 | `actualHours = 4` が表示される |

#### TC-E2E-004: 障害登録 → ステータス更新フロー

**前提条件:** 開発者ロールでログイン済み

| ステップ | 操作 | 画面 | 検証項目 |
|---------|------|------|---------|
| 1 | 「障害管理票」を開く | SCR-C-007 | 障害一覧が表示される |
| 2 | 「+ 障害登録」ボタンをクリック | SCR-C-007 | BugSlideOver（登録モード）が開く |
| 3 | タイトル・発生日・発見フェーズ・重要度を入力して「保存」 | SCR-C-007 | — |
| 4 | 障害番号「BUG-001」で一覧に追加されることを確認 | SCR-C-007 | `bugNumber = "BUG-001"`、`status = "未対応"` が表示される |
| 5 | 障害行をクリックして詳細スライドオーバーを開き、ステータスを「調査中」に変更して「保存」 | SCR-C-007 | — |
| 6 | ステータスが「調査中」に更新されることを確認 | SCR-C-007 | `StatusBadge` が「調査中」を表示 |

#### TC-E2E-005: レポート画面（EVM グラフ）表示

**前提条件:** PM ロールでログイン済み、タスク・日報データが 1 週間分存在

| ステップ | 操作 | 画面 | 検証項目 |
|---------|------|------|---------|
| 1 | 「レポート・分析」を開く | SCR-C-008 | タブ切替と期間フィルタが表示される |
| 2 | 「EVM分析」タブがデフォルト表示されることを確認 | SCR-C-008 | EVM 折れ線グラフが描画される |
| 3 | グラフ下部の SPI / CPI / 残工数が数値で表示されることを確認 | SCR-C-008 | 各指標に数値が表示される（エラーなし） |
| 4 | 「信頼性成長曲線」タブをクリック | SCR-C-008 | 累積バグ発見数・修正完了数の折れ線グラフが描画される |

---

## テストデータ

### テストユーザー

| テストユーザー | メールアドレス | ロール | 用途 |
|--------------|--------------|------|------|
| 管理者 | `admin@test.local` | `admin` | ユーザー管理・全機能テスト |
| PMO | `pmo@test.local` | `pmo` | 閲覧権限テスト |
| プロジェクトマネージャー | `pm@test.local` | `pm` | WBS・プロジェクト管理テスト |
| 開発者 | `dev1@test.local` | `developer` | 日報・障害・レビュー登録テスト |
| 開発者2（複数ユーザーテスト用） | `dev2@test.local` | `developer` | 担当者変更・複数ユーザーシナリオ |
| 無効ユーザー | `inactive@test.local` | `developer` | `is_active = false`。ログイン拒否テスト |

### テストプロジェクト・マスタデータ

**プロジェクト:**

| プロジェクト名 | PM | ステータス | 用途 |
|-------------|-----|---------|------|
| テストプロジェクトA | `pm@test.local` | `active` | 標準テスト用（全機能テスト） |
| テストプロジェクトB（アーカイブ） | `pm@test.local` | `archived` | フィルタテスト用 |

**指摘区分（プロジェクトA）:**

| name | sort_order |
|------|-----------|
| 設計漏れ | 1 |
| 実装誤り | 2 |
| テスト不足 | 3 |
| スタイル | 4 |
| その他 | 5 |

### テストデータ管理方針

| 項目 | 方針 |
|------|------|
| 管理場所 | `tests/fixtures/` ディレクトリに JSON または TypeScript で定義 |
| 生成方法 | 静的フィクスチャ（主要な固定データ）＋ Prisma `createMany` による一括投入 |
| セットアップ | テスト実行前に `prisma migrate reset --force` でクリーン DB を構築し、シードデータを投入 |
| クリーンアップ | 各テストファイルの `afterEach` でテーブルをトランケート（`TRUNCATE ... RESTART IDENTITY CASCADE`） |
| テスト間の独立性 | 各テストは独立したデータセットを使用する。テスト間でデータを共有しない |
| 境界値データ | タスク名255文字・コメント500文字等の境界値データをフィクスチャに含める |
| 個人情報 | テストデータには実在の個人情報を使用しない。すべて `@test.local` ドメインのダミーデータを使用 |

!!! note "CI 環境でのテスト DB"
    GitHub Actions では `docker compose -f compose.test.yml up -d` でテスト用 PostgreSQL コンテナを起動してから結合テストを実行する。テスト終了後はコンテナを破棄する。

!!! note "E2E テストのベースデータ"
    Playwright の E2E テストは `beforeAll` でプロジェクト・タスク・日報のシードデータを投入し、`afterAll` でクリーンアップする。各シナリオは完全な業務データセットを持った状態から開始する。
