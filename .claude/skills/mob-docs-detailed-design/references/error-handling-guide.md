# エラーハンドリング 作成ガイド

## 目次

1. [エラーコード一覧 (error-code-list.md)](#エラーコード一覧)
2. [エラーレスポンス形式 (error-response-format.md)](#エラーレスポンス形式)
3. [例外処理方針 (exception-handling.md)](#例外処理方針)

## 作成順序

error-code-list.md → error-response-format.md → exception-handling.md の順に作成する。
エラーコード体系を最初に確立し、レスポンス形式でクライアントへの伝達方法を定義、例外処理方針でアプリケーション内部の処理フローを確定する。

## 参照すべきドキュメント

- `docs/03-basic-design/api-design/api-overview.md` — API共通仕様（エラーレスポンス形式の基盤）
- `docs/03-basic-design/api-design/` — 各API仕様（個別のエラーケース）
- `docs/03-basic-design/batch-design/` — バッチ定義（バッチ処理のエラーケース）
- `docs/02-technical-design/security/authentication.md` — 認証エラーの定義
- `docs/02-technical-design/security/authorization.md` — 認可エラーの定義
- `docs/01-requirements/non-functional-requirements/security.md` — セキュリティ要件（情報漏洩防止の考慮）

---

## エラーコード一覧

### エラーコード体系に含める内容

プロジェクト全体で統一されたエラーコード体系を定義する。

**コード形式:** `ERR-{カテゴリ}-{連番}`

**カテゴリ一覧:**

| カテゴリ | プレフィックス | 説明 |
|---------|-------------|------|
| 認証 | ERR-AUTH | ログイン・トークン関連のエラー |
| 認可 | ERR-PERM | 権限不足に関するエラー |
| バリデーション | ERR-VAL | 入力値検証のエラー |
| ビジネスロジック | ERR-BIZ | 業務ルール違反のエラー |
| リソース | ERR-RES | リソースの存在・状態に関するエラー |
| 外部サービス | ERR-EXT | 外部サービス連携のエラー |
| システム | ERR-SYS | システム内部のエラー |
| レート制限 | ERR-RATE | リクエスト制限超過のエラー |

※ カテゴリはプロジェクトの要件に応じて追加・調整すること。

### エラーコード一覧テーブルに含める内容

**記載フォーマット:**

| エラーコード | HTTPステータス | ユーザー向けメッセージ | 内部メッセージ | 発生条件 | 対処方法 |
|-------------|---------------|---------------------|--------------|---------|---------|
| ERR-AUTH-001 | 401 | ログインに失敗しました | Invalid credentials | メール/パスワード不一致 | 入力内容を確認して再試行 |
| ERR-AUTH-002 | 401 | セッションが切れました | Token expired | JWTの有効期限切れ | 再ログインまたはトークンリフレッシュ |
| ERR-AUTH-003 | 401 | アカウントが停止されています | Account suspended | アカウントステータスが停止中 | サポートへ問い合わせ |
| ERR-VAL-001 | 400 | 入力内容に誤りがあります | Validation failed | バリデーションルール違反 | エラー詳細を確認して修正 |
| ERR-BIZ-001 | 422 | （業務に応じたメッセージ） | （内部メッセージ） | （業務ルール違反の条件） | （対処方法） |
| ERR-RES-001 | 404 | 指定されたリソースが見つかりません | Resource not found | IDに該当するリソースなし | URLまたはIDを確認 |
| ERR-RES-002 | 409 | データが競合しています | Resource conflict | 一意制約違反 | 既存データを確認 |
| ERR-EXT-001 | 502 | サービスが一時的に利用できません | External service unavailable | 外部サービスのタイムアウト/エラー | 時間を置いて再試行 |
| ERR-SYS-001 | 500 | システムエラーが発生しました | Unexpected error | 想定外の例外 | サポートへ問い合わせ |
| ERR-RATE-001 | 429 | リクエストが多すぎます | Rate limit exceeded | レート制限超過 | 時間を置いて再試行 |

※ 上記は一般的なWebアプリケーションでの典型例。プロジェクトのAPI仕様・業務ルールに基づいて具体化すること。

### セキュリティ考慮事項

**記載すべき項目:**
- 認証エラーで具体的な原因を返さない（「メールアドレスが存在しない」等は不可）
- スタックトレースを本番環境のレスポンスに含めない
- 内部エラーコードとユーザー向けメッセージを分離する
- 列挙攻撃を防ぐため、リソースの存在確認に関するエラーメッセージを統一する

### 品質基準

- 基本設計の全API仕様で定義されたエラーケースが網羅されていること
- バッチ処理のエラーケースが網羅されていること
- エラーコードが一意であること
- ユーザー向けメッセージが技術的な詳細を含まないこと
- セキュリティ上の情報漏洩リスクがないこと

---

## エラーレスポンス形式

### 標準エラーレスポンス構造に含める内容

基本設計のAPI共通仕様で定義されたエラーレスポンス形式を詳細化する。

**標準エラーレスポンス:**

```json
{
  "error": {
    "code": "ERR-VAL-001",
    "message": "入力内容に誤りがあります",
    "details": [
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "メールアドレスの形式が正しくありません"
      },
      {
        "field": "password",
        "code": "TOO_SHORT",
        "message": "パスワードは8文字以上で入力してください"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z",
    "request_id": "req-uuid-12345"
  }
}
```

※ レスポンス構造は基本設計のAPI共通仕様に準拠する。プロジェクトの要件に応じて調整すること。

### エラーレスポンスの種類ごとの形式

**1. バリデーションエラー（400）:**
- `details` にフィールド単位のエラーを配列で返す
- 全フィールドのエラーを一度に返す（1つずつではない）

**2. 認証エラー（401）:**
- `details` は含めない（セキュリティ考慮）
- `WWW-Authenticate` ヘッダーを含める

**3. 認可エラー（403）:**
- 必要な権限の情報は含めない（セキュリティ考慮）

**4. ビジネスロジックエラー（422）:**
- `details` にビジネスルール違反の具体的な理由を返す

**5. サーバーエラー（500）:**
- 汎用メッセージのみ返す
- `request_id` を含めてサポート問い合わせに利用

### フロントエンドでのエラー表示方針に含める内容

**記載すべき項目:**
- エラーメッセージの表示位置（トースト / インライン / ページ全体）
- バリデーションエラーの表示タイミング（入力時 / 送信時）
- ネットワークエラーの表示方法
- リトライUI（再試行ボタン等）の表示条件

**エラー表示パターン:**

| エラー種類 | 表示方法 | 表示位置 | 自動消去 |
|-----------|---------|---------|---------|
| バリデーション | インラインメッセージ | フォームフィールド直下 | フィールド修正時 |
| ビジネスロジック | トースト通知 | 画面右上 | 5秒後 |
| 認証エラー | リダイレクト + メッセージ | ログインページ | — |
| ネットワークエラー | バナー通知 | 画面上部 | 接続回復時 |
| サーバーエラー | エラーページ | 全画面 | — |

### 品質基準

- エラーレスポンスの構造がAPI共通仕様と整合していること
- すべてのHTTPステータスコードに対応するレスポンス形式が定義されていること
- フロントエンドのエラー表示方針がUXを考慮していること
- `request_id` による問い合わせ追跡が可能であること

---

## 例外処理方針

### アプリケーション内の例外分類に含める内容

例外をビジネス例外とシステム例外に分類し、それぞれの処理方針を定義する。

**例外分類:**

| 分類 | 説明 | リカバリ | 例 |
|------|------|---------|-----|
| ビジネス例外 | 業務ルール違反 | ユーザー操作で回復可能 | バリデーションエラー、在庫不足、権限不足 |
| システム例外 | システム障害 | 自動リカバリまたは運用対応 | DB接続失敗、外部サービスタイムアウト |
| プログラムエラー | バグ | 修正が必要 | NullPointerException、型エラー |

### レイヤ別例外処理方針に含める内容

各アーキテクチャレイヤでの例外処理方針を定義する。

**コントローラ層（APIエンドポイント）:**

| 処理 | 方針 |
|------|------|
| ビジネス例外のキャッチ | エラーコードに変換してレスポンス返却 |
| バリデーション例外 | 400レスポンスに変換 |
| 未認証例外 | 401レスポンスに変換 |
| 未認可例外 | 403レスポンスに変換 |
| その他の例外 | 500レスポンスに変換、ログ出力 |

**サービス層:**

| 処理 | 方針 |
|------|------|
| ビジネスルール違反 | ビジネス例外をスロー |
| リポジトリ例外 | 適切なビジネス例外またはシステム例外に変換 |
| 外部サービス例外 | リトライ後、システム例外に変換 |
| トランザクション失敗 | ロールバック、ビジネス例外をスロー |

**リポジトリ層:**

| 処理 | 方針 |
|------|------|
| レコード未発見 | null返却またはNotFound例外 |
| 一意制約違反 | Conflict例外に変換 |
| 接続エラー | システム例外をスロー |
| タイムアウト | システム例外をスロー |

### グローバル例外ハンドラに含める内容

フレームワークレベルでの例外一括処理の設計を定義する。

**記載すべき項目:**
- 例外クラスとHTTPステータスコードのマッピング
- エラーレスポンスへの変換ロジック
- ログ出力の方針（ビジネス例外: WARN、システム例外: ERROR）
- 開発環境と本番環境での挙動の違い（スタックトレースの有無等）

**マッピング例:**

| 例外クラス | HTTPステータス | ログレベル | エラーコード |
|-----------|---------------|-----------|------------|
| ValidationException | 400 | WARN | ERR-VAL-XXX |
| AuthenticationException | 401 | WARN | ERR-AUTH-XXX |
| AuthorizationException | 403 | WARN | ERR-PERM-XXX |
| NotFoundException | 404 | WARN | ERR-RES-001 |
| BusinessException | 422 | WARN | ERR-BIZ-XXX |
| ExternalServiceException | 502 | ERROR | ERR-EXT-XXX |
| Exception（その他） | 500 | ERROR | ERR-SYS-001 |

※ 例外クラス名はフレームワーク・言語に応じて調整すること。

### リトライ・サーキットブレーカーに含める内容

外部サービス呼び出しの耐障害性設計を定義する。

**リトライ方針:**

| 対象 | 最大リトライ回数 | 間隔 | バックオフ |
|------|----------------|------|----------|
| 外部API呼び出し | 3回 | 1秒 | 指数バックオフ |
| DB接続 | 2回 | 500ms | 固定間隔 |
| メッセージキュー | 5回 | 1秒 | 指数バックオフ（最大30秒） |

※ 上記はあくまで一般的な例。プロジェクトの非機能要件に基づいて設定値を決定すること。

**サーキットブレーカー:**

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| 失敗率閾値 | 50% | この割合を超えるとOpen状態に遷移 |
| 評価ウィンドウ | 10リクエスト | 直近のリクエスト数で評価 |
| Open維持時間 | 30秒 | この時間後にHalf-Open状態で再試行 |
| Half-Open許可数 | 3リクエスト | 成功すればClosedに復帰 |

### バッチ処理のエラーハンドリングに含める内容

**記載すべき項目:**
- レコード単位のエラー処理（スキップ / 中断）
- エラーログの出力形式
- リトライ方針（自動 / 手動）
- アラート通知条件（エラー率の閾値等）
- 冪等性の確保方針

### 品質基準

- すべてのレイヤで例外処理方針が定義されていること
- ビジネス例外とシステム例外が明確に分離されていること
- グローバル例外ハンドラがすべての例外を適切に処理すること
- 外部サービス呼び出しにリトライ・サーキットブレーカーが設定されていること
- バッチ処理のエラーハンドリングが基本設計のバッチ定義と整合していること
- ログ出力方針が方式設計のログ方式と整合していること
