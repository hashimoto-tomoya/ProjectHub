# テスト設計 作成ガイド

## 目次

1. [テスト戦略 (test-strategy.md)](#テスト戦略)
2. [テストケース](#テストケース)
   - [単体テスト (unit-test.md)](#単体テスト)
   - [結合テスト (integration-test.md)](#結合テスト)
   - [E2Eテスト (e2e-test.md)](#e2eテスト)
3. [テストデータ (test-data.md)](#テストデータ)

## Smallテンプレートの場合

Smallテンプレートでは、テスト戦略・主要テストケースを **`testing.md`** 1ファイルに統合して記述する。

### 推奨構成

```markdown
# テスト設計

## テスト戦略

### テスト方針
{テストピラミッド方針・カバレッジ目標・使用ツールを簡潔に記述}

### テスト環境
{テスト環境構成を簡潔に記述}

## 主要テストケース

### 単体テスト

| テストID | 対象 | テスト内容 | 期待結果 |
|----------|------|-----------|----------|
| TC-UT-001 | {対象} | {内容} | {期待結果} |
| ... | ... | ... | ... |

### 結合テスト

| テストID | 対象API | テスト内容 | 期待結果 |
|----------|---------|-----------|----------|
| TC-IT-001 | {API} | {内容} | {期待結果} |
| ... | ... | ... | ... |

### E2Eテスト

| テストID | シナリオ | テスト手順概要 | 期待結果 |
|----------|----------|--------------|----------|
| TC-E2E-001 | {シナリオ} | {手順概要} | {期待結果} |
| ... | ... | ... | ... |

## テストデータ概要
{主要なテストデータの方針を簡潔に記述}
```

### Fullとの主な差異

- テスト戦略＋テストケース（単体・結合・E2E）＋テストデータを1ファイルにまとめる
- テストケースは主要なもの各3〜5件程度に絞る（全網羅は不要）
- テストデータは方針概要のみ（詳細なデータセット定義は省略可）
- テスト戦略セクションは方針・ツール・環境を簡潔にまとめる
- 以下の各セクション別ガイドの内容を参考にしつつ、小規模プロジェクトに必要十分な粒度でまとめる

---

## 作成順序（Fullテンプレート）

test-strategy.md → unit-test.md → integration-test.md → e2e-test.md → test-data.md の順に作成する。
テスト戦略で全体方針を確立し、粒度の小さいテストから順に定義、最後にテストデータを横断的に整理する。

## 参照すべきドキュメント

- `docs/01-requirements/functional-requirements/` — 機能要件（テスト対象の特定）
- `docs/01-requirements/non-functional-requirements/` — 非機能要件（性能テスト・セキュリティテストの根拠）
- `docs/01-requirements/use-cases/` — ユースケース（E2Eテストシナリオの根拠）
- `docs/03-basic-design/api-design/` — API仕様（結合テストの根拠）
- `docs/03-basic-design/screen-design/` — 画面定義（E2Eテストの根拠）
- `docs/04-detailed-design/component-design/` — コンポーネント設計（単体テストの対象特定）
- `docs/04-detailed-design/error-handling/` — エラーハンドリング（異常系テストの根拠）

---

## テスト戦略

### テスト全体方針に含める内容

プロジェクト全体のテスト方針を定義する。

**テストピラミッド:**

テストの量と投資のバランスを定義する。

```
        /   E2E   \          ← 少数の重要シナリオ
       / Integration \       ← API・サービス連携の検証
      /   Unit Tests   \    ← 大量のロジック検証
```

**各レベルの目標:**

| テストレベル | 目的 | 対象 | 実行頻度 |
|-------------|------|------|---------|
| 単体テスト | ロジックの正確性検証 | ドメインモデル、サービス層、ユーティリティ | コミット時 |
| 結合テスト | コンポーネント間連携の検証 | API エンドポイント、DB連携、外部サービス連携 | PR作成時 |
| E2Eテスト | ユーザーシナリオの検証 | 画面操作 → API → DB の一連のフロー | デプロイ前 |

### テストツール選定に含める内容

方式設計の技術スタックに基づいてテストツールを選定する。

**記載すべき項目:**

| カテゴリ | ツール | 用途 |
|---------|-------|------|
| テストランナー | （例: Jest / Vitest / pytest） | テスト実行・レポート |
| アサーション | （例: Jest expect / Chai） | 期待値の検証 |
| モック | （例: Jest mock / unittest.mock） | 依存の置き換え |
| APIテスト | （例: Supertest / httpx） | HTTPリクエストテスト |
| E2Eテスト | （例: Playwright / Cypress） | ブラウザ操作テスト |
| カバレッジ | （例: Istanbul / coverage.py） | カバレッジ計測 |

※ ツール選定は技術スタックに応じて適切なものを選ぶこと。

### カバレッジ目標に含める内容

| テストレベル | 対象 | カバレッジ目標 | 備考 |
|-------------|------|--------------|------|
| 単体テスト | ドメインモデル | 90%以上 | ビジネスロジックの中核 |
| 単体テスト | サービス層 | 80%以上 | ユースケースの実行 |
| 単体テスト | ユーティリティ | 90%以上 | 共通処理 |
| 結合テスト | APIエンドポイント | 全エンドポイント | 正常系・主要異常系 |
| E2Eテスト | 主要業務フロー | 全主要フロー | 画面遷移を含む |

※ カバレッジ目標はプロジェクトの品質要件に応じて調整すること。

### テスト環境に含める内容

**記載すべき項目:**
- テスト用データベース（テスト専用インスタンス / インメモリDB）
- 外部サービスのモック方針（モックサーバー / スタブ）
- テストデータのセットアップ・クリーンアップ方針
- CI/CDパイプラインでのテスト実行タイミング

### 品質基準

- テストピラミッドの各レベルで目標が定義されていること
- テストツールが技術スタックと整合していること
- カバレッジ目標が非機能要件の品質基準と整合していること

---

## テストケース

### 単体テスト

#### テスト対象の特定

コンポーネント設計で定義した以下の要素を単体テストの対象とする：

| 対象 | テスト観点 | 優先度 |
|------|-----------|-------|
| ドメインモデル（エンティティ） | ビジネスルール・不変条件の検証 | 高 |
| ドメインモデル（値オブジェクト） | バリデーション・等価性の検証 | 高 |
| サービス層 | ユースケース実行ロジックの検証 | 高 |
| リポジトリ層 | データアクセスロジックの検証（モックDB使用） | 中 |
| FEコンポーネント | レンダリング・イベントハンドラの検証 | 中 |
| ユーティリティ | ヘルパー関数の入出力検証 | 中 |

#### テストケース記載フォーマット

**ドメインモデルのテストケース例:**

```markdown
### DOM-001: User エンティティ

| TC-ID | テスト観点 | 入力 | 期待結果 | 区分 |
|-------|-----------|------|---------|------|
| TC-UT-001 | 正常なユーザー作成 | 有効なemail, password, name | Userインスタンスが生成される | 正常系 |
| TC-UT-002 | 無効なメール形式 | email="invalid" | バリデーションエラー | 異常系 |
| TC-UT-003 | パスワード文字数不足 | password="short" | バリデーションエラー | 異常系 |
| TC-UT-004 | メールアドレス変更 | 有効な新メールアドレス | emailが更新される | 正常系 |
| TC-UT-005 | アカウント停止 | ACTIVE状態のUser | statusがSUSPENDEDに変更 | 正常系 |
| TC-UT-006 | 退会済みユーザーの操作 | WITHDRAWN状態のUser | ビジネス例外がスロー | 異常系 |
```

※ 上記はユーザーエンティティの例。プロジェクトのドメインモデルに応じてテストケースを定義すること。

**サービス層のテストケース例:**

```markdown
### SVC-001: UserService

| TC-ID | テスト観点 | 前提条件 | 入力 | モック設定 | 期待結果 | 区分 |
|-------|-----------|---------|------|-----------|---------|------|
| TC-UT-010 | 正常な登録 | — | 有効な登録情報 | repo.findByEmail→null | User作成、repo.save呼出 | 正常系 |
| TC-UT-011 | メール重複 | — | 既存メール | repo.findByEmail→User | ERR-RES-002 | 異常系 |
| TC-UT-012 | 正常なログイン | 登録済User | 正しい認証情報 | repo.findByEmail→User | AuthToken返却 | 正常系 |
| TC-UT-013 | パスワード不一致 | 登録済User | 誤パスワード | repo.findByEmail→User | ERR-AUTH-001 | 異常系 |
```

※ 上記はユーザーサービスの例。各サービスのメソッドに対してテストケースを定義すること。

#### モック方針に含める内容

| テスト対象 | モック対象 | モック手法 |
|-----------|-----------|-----------|
| ドメインモデル | なし（純粋なロジック） | — |
| サービス層 | リポジトリ、外部サービス | モックオブジェクト |
| リポジトリ層 | データベース | インメモリDB / モック |
| FEコンポーネント | API呼び出し、ストア | MSW / モックストア |

#### 品質基準

- ドメインモデルの全ビジネスルールに対応するテストケースが存在すること
- サービス層の全メソッドに正常系・主要異常系のテストケースが存在すること
- エラーコード一覧の全エラーに対応するテストケースが存在すること
- 境界値テストが含まれていること

---

### 結合テスト

#### テスト対象の特定

コンポーネント間の連携を検証するテストを定義する。

| 対象 | テスト観点 | テスト範囲 |
|------|-----------|-----------|
| APIエンドポイント | リクエスト → レスポンスの正確性 | Controller → Service → Repository → DB |
| 外部サービス連携 | 連携データの送受信 | Service → 外部サービス（モック） |
| バッチ処理 | 入力データ → 処理結果 | バッチ → Service → Repository → DB |
| 認証・認可 | アクセス制御の正確性 | 認証ミドルウェア → Controller |

#### テストケース記載フォーマット

**APIエンドポイントのテストケース例:**

```markdown
### API-C-001: 認証API

| TC-ID | テスト観点 | メソッド | パス | リクエスト | 期待ステータス | 期待レスポンス | 区分 |
|-------|-----------|---------|------|-----------|-------------|--------------|------|
| TC-IT-001 | 正常な会員登録 | POST | /api/v1/auth/register | 有効なemail,password | 201 | Userオブジェクト | 正常系 |
| TC-IT-002 | メール重複の登録 | POST | /api/v1/auth/register | 既存email | 409 | ERR-RES-002 | 異常系 |
| TC-IT-003 | バリデーション違反 | POST | /api/v1/auth/register | 無効なemail | 400 | ERR-VAL-001 | 異常系 |
| TC-IT-004 | 正常なログイン | POST | /api/v1/auth/login | 正しい認証情報 | 200 | AuthToken | 正常系 |
| TC-IT-005 | 認証必須APIへの未認証アクセス | GET | /api/v1/users/me | ヘッダーなし | 401 | ERR-AUTH-002 | 異常系 |
```

※ 上記は認証APIの例。プロジェクトの全APIエンドポイントに対してテストケースを定義すること。

#### テストデータベース方針に含める内容

**記載すべき項目:**
- テスト用データベースの構築方法（マイグレーション適用）
- テストデータのセットアップ方法（シード / ファクトリ）
- テスト間の分離方法（トランザクションロールバック / テーブルクリーン）
- テスト順序の独立性の確保方法

#### 品質基準

- 基本設計の全APIエンドポイントの正常系・主要異常系がカバーされていること
- 認証・認可の制御が全保護エンドポイントでテストされていること
- テスト間の独立性が確保されていること
- 外部サービスがモック化されていること

---

### E2Eテスト

#### テスト対象の特定

ユーザーの業務フローを画面操作レベルで検証するテストを定義する。対象はユースケース定義に基づく。

| 対象フロー | 優先度 | 根拠 |
|-----------|-------|------|
| （主要ユースケース1） | 高 | ビジネスの中核フロー |
| （主要ユースケース2） | 高 | 売上に直結するフロー |
| （補助ユースケース） | 中 | 使用頻度の高いフロー |

※ 対象フローはプロジェクトのユースケースに基づいて決定する。全ユースケースをE2Eテストにする必要はなく、ビジネスインパクトの高いフローに集中する。

#### テストケース記載フォーマット

**E2Eテストシナリオ例:**

```markdown
### TC-E2E-001: ユーザー登録〜ログインフロー

**前提条件:** 未登録ユーザー

| ステップ | 操作 | 画面 | 検証項目 |
|---------|------|------|---------|
| 1 | トップページを開く | トップページ | ページが表示される |
| 2 | 「新規登録」リンクをクリック | トップページ | 会員登録画面に遷移 |
| 3 | 登録フォームを入力 | 会員登録画面 | — |
| 4 | 「登録」ボタンをクリック | 会員登録画面 | 登録完了メッセージが表示される |
| 5 | ログインフォームを入力 | ログイン画面 | — |
| 6 | 「ログイン」ボタンをクリック | ログイン画面 | マイページに遷移、ユーザー名が表示される |
```

※ 上記はユーザー登録フローの例。プロジェクトの主要業務フローに応じてシナリオを定義すること。

#### 画面キャプチャ・スクリーンショットの方針に含める内容

**記載すべき項目:**
- テスト実行時のスクリーンショット取得方針
- 失敗時の自動キャプチャ設定
- ビジュアルリグレッションテストの適用範囲（該当する場合）

#### レスポンシブテストに含める内容

**記載すべき項目:**
- テスト対象のデバイス・画面サイズ
- ブレイクポイントごとのテスト項目

| デバイス | 画面幅 | 優先度 |
|---------|--------|-------|
| デスクトップ | 1920px | 高 |
| タブレット | 768px | 中 |
| スマートフォン | 375px | 高 |

#### 品質基準

- ユースケース定義の主要フローがE2Eテストでカバーされていること
- 正常系だけでなく主要な異常系（エラー表示）もテストされていること
- テストが安定して実行できること（Flaky testの排除）
- テスト実行時間が許容範囲内であること

---

## テストデータ

### テストデータ設計に含める内容

テスト全体で使用するデータを定義する。

#### マスタデータ

基本設計のマスタデータ定義に基づき、テスト用のマスタデータを定義する。

**記載フォーマット:**

```markdown
### カテゴリマスタ（テスト用）

| ID | 名称 | 備考 |
|----|------|------|
| 1 | カテゴリA | テスト用 |
| 2 | カテゴリB | テスト用 |
| 3 | カテゴリC | テスト用 |
```

※ テスト用マスタデータは最小限のセットとする。全件テストが必要な場合は追加セットを用意する。

#### テストユーザー

テストで使用するユーザーアカウントを定義する。

| テストユーザー | メールアドレス | 権限 | 用途 |
|--------------|--------------|------|------|
| 一般ユーザー1 | test-user1@example.com | 一般 | 標準的なテスト |
| 一般ユーザー2 | test-user2@example.com | 一般 | 複数ユーザーテスト |
| 管理者 | test-admin@example.com | 管理者 | 管理機能テスト |
| 停止ユーザー | test-suspended@example.com | 一般（停止中） | 停止アカウントテスト |

#### 業務データ

テストシナリオで使用する業務データを定義する。

**記載すべき項目:**
- 正常系テスト用データ（有効な値のセット）
- 境界値テスト用データ（最小値・最大値・境界値）
- 異常系テスト用データ（無効な値のセット）
- 大量データテスト用データ（性能テスト用、件数と生成方法）

#### テストデータ管理方針に含める内容

**記載すべき項目:**
- テストデータの管理場所（fixtures / factories / seed files）
- テストデータの生成方法（静的定義 / ファクトリパターン / Faker等）
- テストデータのライフサイクル（セットアップ → テスト実行 → クリーンアップ）
- 本番データの利用方針（マスキング要否、利用制限）

### 品質基準

- すべてのテストケースに必要なテストデータが定義されていること
- テストデータがドメインモデルのバリデーションルールに適合していること
- テストデータ間の依存関係が明確であること（参照整合性）
- 個人情報を含むテストデータが適切にマスキングされていること
