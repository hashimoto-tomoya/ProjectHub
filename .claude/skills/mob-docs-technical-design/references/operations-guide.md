# 運用方式 作成ガイド

## 目次

1. [監視方式 (monitoring.md)](#監視方式)
2. [ログ方式 (logging.md)](#ログ方式)
3. [DR方式 (disaster-recovery.md)](#dr方式)

## 作成順序

monitoring.md → logging.md → disaster-recovery.md の順に作成する。
監視でシステムの健全性把握方法を定義し、ログで詳細なトレーサビリティを設計、DRで障害からの復旧方式を策定する。

---

## 監視方式

### 監視対象に含める内容

**監視レイヤーとメトリクス:**

| レイヤー | 監視対象 | 主要メトリクス |
|---------|---------|---------------|
| インフラ | CPU、メモリ、ディスク、ネットワーク | 使用率、IOPS、スループット |
| コンテナ / プロセス | コンテナ状態、プロセス数 | 再起動回数、OOMイベント |
| アプリケーション | レスポンスタイム、エラー率、スループット | P50/P95/P99レイテンシ |
| ビジネス | KPIメトリクス（プロジェクト固有） | リアルタイム集計値 |
| 外部サービス | 連携先API | レスポンスタイム、エラー率 |

**プロジェクト特性に応じた監視項目の例:**
- ビジネスKPIの異常検知（例: ECなら注文数・決済成功率、SaaSならアクティブユーザー数）
- コンバージョンファネルの異常検知
- トラフィックスパイク監視（セール、キャンペーン等）
- リソース残量の急減検知（例: 在庫、座席、クォータ）

### 監視ツールに含める内容

**主要な選択肢:**

| ツール | 領域 | 特徴 |
|--------|------|------|
| CloudWatch | インフラ・アプリ | AWS統合、低コスト開始 |
| Datadog | フルスタック | 統合ダッシュボード、APM |
| Prometheus + Grafana | メトリクス | OSS、カスタマイズ性 |
| New Relic | APM | 詳細トレース、エラー追跡 |

**記載すべき項目:**
- 選定ツールと選定理由
- ダッシュボード設計（運用・ビジネス・インフラ別）
- 分散トレーシングの導入方針（OpenTelemetry等）

### アラート設計に含める内容

**アラートレベル定義:**

| レベル | 条件例 | 通知先 | 対応時間 |
|--------|-------|--------|---------|
| Critical | サービス停止、主要機能不可 | オンコール担当（電話） | 15分以内 |
| Warning | エラー率上昇、レイテンシ悪化 | Slack通知 | 1時間以内 |
| Info | デプロイ完了、スケールイベント | Slack通知 | 確認のみ |

**記載すべき項目:**
- メトリクスごとの閾値設定
- エスカレーションフロー
- オンコール体制（ローテーション方針）
- アラート疲れ防止策（集約、抑制ルール）

### 品質基準

- SLA/SLOに対応する監視メトリクスが定義されていること
- アラートレベルと対応フローが明確であること
- ビジネスメトリクスの監視が含まれていること

---

## ログ方式

### ログ種別に含める内容

| 種別 | 内容 | 出力先 | 用途 |
|------|------|--------|------|
| アクセスログ | HTTPリクエスト/レスポンス | ログ基盤 | トラフィック分析 |
| アプリケーションログ | 業務処理の実行記録 | ログ基盤 | 障害調査 |
| エラーログ | 例外・エラー情報 | ログ基盤 + アラート | 障害検知・調査 |
| 監査ログ | ユーザー操作、権限変更 | 監査用ストレージ | セキュリティ監査 |
| セキュリティログ | 認証試行、不正アクセス | SIEM | セキュリティ分析 |

### ログフォーマットに含める内容

**構造化ログの推奨フォーマット（JSON）:**

```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "level": "INFO",
  "service": "api-service",
  "traceId": "abc123",
  "spanId": "def456",
  "userId": "user-789",
  "message": "Resource created",
  "metadata": {
    "resourceId": "res-001",
    "action": "create"
  }
}
```

**記載すべき項目:**
- 必須フィールド定義
- ログレベルの使い分け基準

| レベル | 用途 | 例 |
|--------|------|-----|
| ERROR | 異常系、要対応 | DB接続失敗、外部API連携エラー |
| WARN | 注意事項、性能劣化 | リトライ発生、閾値接近 |
| INFO | 正常系の重要イベント | トランザクション完了、ユーザー登録 |
| DEBUG | 開発時の詳細情報 | SQL発行、API呼出詳細 |

- 個人情報のマスキングルール（メールアドレス、電話番号等）
- トレースID/スパンIDの付与ルール

### ログ基盤に含める内容

**主要な構成パターン:**

| パターン | 構成 | 特徴 |
|---------|------|------|
| ELKスタック | Elasticsearch + Logstash + Kibana | OSS、高カスタマイズ性 |
| EFKスタック | Elasticsearch + Fluentd + Kibana | 軽量収集、Kubernetes親和 |
| CloudWatch Logs | AWS CloudWatch | マネージド、AWS統合 |
| Datadog Logs | Datadog | 統合プラットフォーム |

**記載すべき項目:**
- 選定した構成と選定理由
- ログ収集方式（サイドカー / エージェント / 直接送信）
- 検索・分析のユースケース

### ログ保持期間に含める内容

| ログ種別 | ホットストレージ | コールドストレージ | 総保持期間 |
|---------|----------------|------------------|-----------|
| アクセスログ | 30日 | 1年 | 1年 |
| アプリケーションログ | 14日 | 90日 | 90日 |
| エラーログ | 90日 | 1年 | 1年 |
| 監査ログ | 1年 | 7年 | 7年 |
| セキュリティログ | 90日 | 3年 | 3年 |

※ 法規制・コンプライアンス要件に基づき調整する。

### 品質基準

- 構造化ログが採用されていること
- トレースIDによるリクエスト追跡が可能であること
- 個人情報のマスキングルールが定義されていること
- 保持期間がコンプライアンス要件を満たしていること

---

## DR方式

### DR戦略に含める内容

**DR分類と目標:**

| 戦略 | RTO | RPO | コスト | 概要 |
|------|-----|-----|--------|------|
| バックアップ＆リストア | 数時間 | 24時間 | 低 | 定期バックアップから復元 |
| パイロットライト | 1時間 | 数分 | 中 | 最小限のコアをDRサイトに常時稼働 |
| ウォームスタンバイ | 数十分 | 数分 | 中〜高 | 縮小版をDRサイトに常時稼働 |
| マルチサイトアクティブ | 数分 | ほぼ0 | 高 | 複数サイトで同時稼働 |

**記載すべき項目:**
- 選定したDR戦略と根拠（RTO/RPO要件との対応）
- DRサイトの構成（リージョン選定）
- フェイルオーバー方式（自動 / 手動）

### バックアップ・リストアに含める内容

**記載すべき項目:**
- バックアップ対象と方式（security-guide.md のバックアップセクションと整合させる）
- クロスリージョンレプリケーション設定
- リストア手順（ステップバイステップ）
- リストア検証方法

### 復旧手順に含める内容

**障害レベル別の復旧フロー:**

| レベル | 影響範囲 | 復旧方式 | 想定所要時間 |
|--------|---------|---------|-------------|
| L1 | 単一インスタンス障害 | オートスケーリングで自動復旧 | 数分 |
| L2 | AZ障害 | Multi-AZフェイルオーバー | 数分〜十数分 |
| L3 | リージョン障害 | DRサイトへのフェイルオーバー | RTO目標時間 |
| L4 | データ損失 | バックアップからのリストア | RPO+リストア時間 |

**記載すべき項目:**
- レベル別の復旧手順チェックリスト
- 復旧判定基準（何をもって復旧完了とするか）
- 関係者への連絡フロー

### 訓練計画に含める内容

**記載すべき項目:**
- DR訓練の実施頻度（半年〜年1回）
- 訓練シナリオ（テーブルトップ / 実機切替 / カオスエンジニアリング）
- 訓練結果の記録・改善サイクル
- ゲームデイの計画

### 品質基準

- RTO/RPOが要件定義の可用性要件と整合していること
- 復旧手順がステップバイステップで記載されていること
- 訓練計画が定義されていること
