# セキュリティ方式 作成ガイド

## 目次

1. [認証方式 (authentication.md)](#認証方式)
2. [認可方式 (authorization.md)](#認可方式)
3. [データ保護 (data-protection.md)](#データ保護)
4. [WAF・DDoS対策 (waf-ddos.md)](#wafddos対策)

## 作成順序

authentication.md → authorization.md → data-protection.md → waf-ddos.md の順に作成する。
認証で「誰であるか」を確立し、認可で「何ができるか」を定義、データ保護で「情報をどう守るか」を規定、最後にWAF/DDoSで「外部攻撃からどう守るか」を策定する。

---

## 認証方式

### 認証方式の選定に含める内容

**主要な選択肢:**

| 方式 | 特徴 | 適するケース |
|------|------|-------------|
| セッションベース | サーバー側セッション管理、Cookie | 従来型Webアプリ |
| JWTベース | ステートレス、トークン管理 | SPA、マイクロサービス |
| OAuth 2.0 + OIDC | 外部IdP連携、標準化 | ソーシャルログイン対応 |
| Passkey / FIDO2 | パスワードレス、高セキュリティ | 先進的UX |

**記載すべき項目:**
- 選定した認証方式と選定理由
- 認証フロー図（Mermaidシーケンス図）
- トークン設計（アクセストークン / リフレッシュトークンの有効期限・保存場所）

### ソーシャルログインに含める内容

**記載すべき項目:**
- 対応するプロバイダ（Google / Apple / LINE 等）と選定基準
- OAuth 2.0フロー（Authorization Code Flow + PKCE 推奨）
- アカウントリンク方式（既存アカウントとの紐付け）
- プロバイダごとに取得するプロフィール情報

### 多要素認証（MFA）に含める内容

**記載すべき項目:**
- MFAの適用範囲（管理者必須 / 顧客任意 等）
- 対応する認証要素（TOTP / SMS / メール / Passkey）
- リカバリー方式（バックアップコード等）

### トークン管理に含める内容

**記載すべき項目:**
- トークン種別と有効期限

| トークン | 有効期限 | 保存場所 | 備考 |
|----------|---------|---------|------|
| アクセストークン | 15〜30分 | メモリ / httpOnly Cookie | 短寿命 |
| リフレッシュトークン | 7〜30日 | httpOnly Cookie / Secure Storage | ローテーション必須 |

- トークンローテーション方針
- 失効（Revocation）の仕組み

### 品質基準

- 認証フローがシーケンス図で図示されていること
- トークンの保存場所がXSS/CSRF対策を考慮していること
- 要件定義のセキュリティ要件と紐付いていること

---

## 認可方式

### 認可モデルの選定に含める内容

**主要な選択肢:**

| モデル | 特徴 | 適するケース |
|--------|------|-------------|
| RBAC（ロールベース） | ロールに権限を割当 | シンプルな権限体系 |
| ABAC（属性ベース） | 属性条件で動的制御 | 複雑な権限要件 |
| PBAC（ポリシーベース） | ポリシー文書で制御 | 柔軟性重視 |

**記載すべき項目:**
- 選定モデルと選定理由
- 認可判定のアーキテクチャ（ミドルウェア / デコレーター / ゲートウェイ等）

### ロール定義に含める内容

以下はECサイトの場合の例。プロジェクトの要件に応じてロール構成をカスタマイズすること。

| ロール | 説明 | 主な権限 |
|--------|------|---------|
| （例）一般ユーザー | サービス利用 | 自身の情報CRUD、基本操作 |
| （例）プレミアムユーザー | 上位ユーザー | 一般ユーザー + 限定機能 |
| （例）オペレーター | 業務運用 | データCRUD、業務管理 |
| （例）管理者 | システム管理 | 全権限 |

### 権限マトリクスに含める内容

リソース × ロール × 操作 の三次元で権限を定義する。

以下はECサイトの場合の例：

```markdown
| リソース | 操作 | 一般ユーザー | オペレーター | 管理者 |
|---------|------|------------|------------|--------|
| コンテンツ | 閲覧 | ○ | ○ | ○ |
| コンテンツ | 登録・編集 | × | ○ | ○ |
| トランザクション | 自分の閲覧 | ○ | ○ | ○ |
| トランザクション | 全件閲覧 | × | ○ | ○ |
| ユーザー | 管理 | × | × | ○ |
```

プロジェクト固有のリソースとロールに置き換えて定義すること。

### 品質基準

- すべてのロールが定義されていること
- 権限マトリクスが網羅的であること
- 最小権限の原則が適用されていること

---

## データ保護

### 暗号化に含める内容

**通信の暗号化:**
- TLSバージョン（TLS 1.2以上必須、1.3推奨）
- 証明書管理方式（ACM / Let's Encrypt 等）
- 内部通信の暗号化方針（サービス間mTLS等）

**保存データの暗号化:**
- DB暗号化方式（AES-256、透過的暗号化等）
- ファイルストレージ暗号化（SSE-S3 / SSE-KMS）
- 暗号鍵管理（KMS / Vault）
- 鍵ローテーション方針

**アプリケーション層の暗号化:**
- パスワードハッシュ（bcrypt / Argon2、ストレッチング回数）
- 機密データのフィールド暗号化（クレジットカード番号、APIキー等）

### 個人情報保護に含める内容

**記載すべき項目:**
- 個人情報の分類と取扱い方針

| 分類 | 例 | 保護レベル | 保持期間 |
|------|----|---------:|---------|
| 特定個人情報 | マイナンバー | 最高 | 法定期間 |
| 要配慮個人情報 | 健康情報 | 高 | 必要最小限 |
| 一般個人情報 | 氏名・住所・メール | 中 | サービス利用期間 |
| 匿名加工情報 | 統計データ | 低 | 分析期間 |

- データマスキング方針（非本番環境での個人情報保護）
- データ削除方針（退会時の処理、論理削除 vs 物理削除）
- 同意管理（Cookie同意、プライバシーポリシー）

### バックアップに含める内容

**記載すべき項目:**
- バックアップ対象と方式

| 対象 | 方式 | 頻度 | 保持期間 | RPO |
|------|------|------|---------|-----|
| DB | 自動スナップショット | 日次 | 30日 | 24時間 |
| DB | PITR | 継続的 | 7日 | 5分 |
| ファイル | クロスリージョン複製 | リアルタイム | 永続 | 0 |

- リストア手順の概要
- バックアップの暗号化方針

### 品質基準

- 暗号化方式が業界標準（AES-256、TLS 1.2+等）を満たすこと
- 個人情報の分類と保護レベルが明確であること
- 要件定義のコンプライアンス要件と整合していること

---

## WAF・DDoS対策

### WAF設定に含める内容

**記載すべき項目:**
- WAFサービスの選定（AWS WAF / Cloudflare WAF 等）
- 適用するルールセット

| ルール | 対象 | 説明 |
|--------|------|------|
| SQLインジェクション | 全API | パラメータのSQLi検知 |
| XSS | 全API | スクリプト注入検知 |
| レートリミット | 認証API | ブルートフォース防止 |
| Geo制限 | 管理画面 | 国内IPのみ許可 |
| カスタムルール | 特定パス | ビジネスロジック保護 |

- ログ・モニタリング方針（ブロック時のアラート等）
- 誤検知時の対応フロー（ホワイトリスト追加手順）

### DDoS対策に含める内容

**記載すべき項目:**
- DDoS防御サービス（AWS Shield / Cloudflare 等）
- 防御対象レイヤー（L3/L4 / L7）
- スケーリングによる吸収方針
- 緊急時対応フロー

### Bot対策に含める内容

**プロジェクト特性に応じた考慮事項の例:**
- スクレイピング防止（コンテンツ・価格情報等の不正取得）
- 不正利用Bot対策（例: ECサイトの買い占め、チケット転売、ポイント不正取得）
- アカウント不正作成防止

**記載すべき項目:**
- Bot検知方式（CAPTCHA / レート制限 / 行動分析）
- 正規Bot（検索エンジン等）の許可方針
- Bot検知時のレスポンス（ブロック / チャレンジ / レート制限）

### 品質基準

- OWASP Top 10の主要脅威がカバーされていること
- プロジェクト固有の脅威（不正利用Bot等）が考慮されていること
- 誤検知対応のフローが定義されていること
