# データ方式 作成ガイド

## 目次

1. [DB選定 (database-selection.md)](#db選定)
2. [キャッシュ戦略 (caching-strategy.md)](#キャッシュ戦略)
3. [ファイルストレージ (file-storage.md)](#ファイルストレージ)

## 作成順序

database-selection.md → caching-strategy.md → file-storage.md の順に作成する。
DB選定でデータの永続化方式を決定し、キャッシュで読み取り性能を最適化、ファイルストレージでバイナリデータの管理方式を定義する。

---

## DB選定

### RDBMS選定に含める内容

**主要な選択肢:**

| DB | 特徴 | 適するケース |
|----|------|-------------|
| PostgreSQL | 拡張性、JSON対応、全文検索 | 汎用、複雑なクエリ |
| MySQL / Aurora | 高速読み取り、実績豊富 | 読み取り主体のワークロード |
| Cloud SQL / RDS | マネージド、運用負荷低 | 運用リソース限定時 |

**記載すべき項目:**
- 選定したRDBMSと選定理由
- マネージドサービスの利用有無
- バージョンポリシー
- 接続方式（コネクションプール設計）
  - プールサイズの設計根拠
  - 接続タイムアウト設定

**プロジェクト特性に応じた考慮事項の例:**
- トランザクション処理のACID特性（例: 注文・決済、予約、申請承認）
- 排他制御（楽観的ロック / 悲観的ロック）（例: 在庫管理、座席予約）
- 読み取りレプリカの活用（読み取り負荷の分散）

### NoSQL選定に含める内容

必要な場合のみ記載する。

**主要な選択肢と用途:**

| DB | データモデル | 用途例 |
|----|-------------|-------|
| Redis | Key-Value | セッション、一時データ、ランキング |
| DynamoDB | Key-Value / Document | カタログ、行動ログ、IoTデータ |
| MongoDB | Document | スキーマレスな属性データ、CMS |

**記載すべき項目:**
- RDBMSとの使い分け基準
- データ整合性の担保方式（結果整合性の許容範囲）

### 検索エンジンに含める内容

全文検索や高度な検索機能が必要な場合に記載する。

**主要な選択肢:**

| エンジン | 特徴 | 考慮事項 |
|---------|------|---------|
| Elasticsearch / OpenSearch | 全文検索、ファセット検索、高性能 | 運用コスト、メモリ消費 |
| Algolia | SaaS、低レイテンシ | 従量課金、データ所在 |
| Meilisearch | 軽量、簡易導入 | 大規模データでの実績 |
| PostgreSQL全文検索 | 追加コスト不要 | 機能限定的 |

**記載すべき項目:**
- 選定した検索エンジンと選定理由
- インデックス設計方針
- 同期方式（リアルタイム / バッチ）
- 検索機能（ファセット、オートコンプリート、同義語、タイプミス補正）

### 品質基準

- 性能要件（レスポンスタイム、同時接続数）との整合性があること
- スケーラビリティの方針が明記されていること
- データ整合性の方針が明確であること

---

## キャッシュ戦略

### キャッシュ階層に含める内容

複数レイヤーのキャッシュを体系的に設計する。

| 層 | 技術 | 対象 | TTL目安 |
|----|------|------|---------|
| ブラウザキャッシュ | Cache-Control | 静的アセット | 1日〜1年 |
| CDNキャッシュ | CloudFront等 | 画像、CSS/JS | 1時間〜1日 |
| アプリケーションキャッシュ | Redis / Memcached | APIレスポンス、セッション | 数分〜1時間 |
| DBクエリキャッシュ | Redis | 頻出クエリ結果 | 数分〜1時間 |

### キャッシュ対象に含める内容

プロジェクトのデータ特性に応じて、キャッシュ対象と方針を設計する。以下はECサイトの場合の例：

| データ | キャッシュ方式 | 更新頻度 | 一貫性要件 |
|--------|-------------|---------|-----------|
| （例）一覧データ | CDN + Redis | 中 | 結果整合で可 |
| （例）詳細データ | Redis | 中 | 結果整合で可 |
| （例）リアルタイムデータ（在庫等） | キャッシュ非推奨 | 高 | 強整合必須 |
| （例）一時的なユーザーデータ（カート等） | Redis | 高 | 強整合推奨 |
| ユーザーセッション | Redis | 高 | 強整合必須 |
| マスタデータ | Redis（長TTL） | 低 | 結果整合で可 |

### キャッシュ無効化に含める内容

**主要な無効化パターン:**

| パターン | 説明 | 適するケース |
|---------|------|-------------|
| TTL期限切れ | 一定時間後に自動失効 | 参照系データ |
| Write-Through | 書き込み時にキャッシュも更新 | 一貫性重要 |
| Cache-Aside + Invalidation | 更新時にキャッシュ削除 | 汎用 |
| Pub/Sub通知 | イベントで無効化伝播 | 分散環境 |

**記載すべき項目:**
- 各キャッシュ対象の無効化方針
- キャッシュスタンピード対策（ロック、確率的早期失効等）
- 障害時のフォールバック（キャッシュ障害時のDB直接参照）

### 品質基準

- キャッシュヒット率の目標値が設定されていること
- リアルタイム性が必要なデータ（在庫、残席等）がキャッシュ対象外であること
- キャッシュ障害時のフォールバックが定義されていること

---

## ファイルストレージ

### ストレージサービスに含める内容

**主要な選択肢:**

| サービス | 特徴 | 適するケース |
|---------|------|-------------|
| Amazon S3 | 高耐久性、低コスト、豊富な連携 | AWS環境、汎用 |
| Google Cloud Storage | BigQuery連携、ライフサイクル管理 | GCP環境 |
| Azure Blob Storage | Azure連携 | Azure環境 |

**記載すべき項目:**
- 選定サービスと選定理由
- バケット設計（用途別分割）
- アクセス制御方針（IAM / バケットポリシー / 署名付きURL）
- ストレージクラスの使い分け（Standard / IA / Glacier等）

### 画像管理に含める内容

画像を扱うプロジェクトでは、画像管理の方式を定義する。

**記載すべき項目:**
- アップロードフロー（クライアント直接 or サーバー経由）
- 画像処理パイプライン

```
アップロード → バリデーション → リサイズ生成 → WebP変換 → CDN配信
```

- サムネイル生成方針（サイズバリエーション）
- 画像最適化（圧縮率、フォーマット選定）
- 命名規則・ディレクトリ構成

### ファイル管理に含める内容

**記載すべき項目:**
- ファイルの種別と保存先

以下は代表的なファイル種別の例。プロジェクトに応じて適宜調整する：

| ファイル種別 | 保存先 | アクセス制御 | 備考 |
|------------|--------|------------|------|
| （例）公開画像 | S3 + CDN | 公開 | WebP変換 |
| （例）ユーザーアバター | S3 + CDN | 公開 | リサイズ |
| （例）帳票PDF | S3 | 署名付きURL | 期限付き |
| （例）エクスポートファイル | S3 | 署名付きURL | 一時ファイル |
| （例）バックアップ | S3 Glacier | 非公開 | 長期保存 |

- ライフサイクルポリシー（古いファイルの自動アーカイブ・削除）
- ウイルススキャン方針（アップロードファイル）
- 最大ファイルサイズ制限

### 品質基準

- ファイル種別ごとにアクセス制御が定義されていること
- 画像配信がCDN経由で最適化されていること
- ストレージコストの最適化方針（ライフサイクル）が定義されていること
