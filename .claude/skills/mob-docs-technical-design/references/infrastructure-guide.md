# インフラ方式 作成ガイド

## 目次

1. [クラウド構成 (cloud-architecture.md)](#クラウド構成)
2. [ネットワーク設計 (network.md)](#ネットワーク設計)
3. [CI/CD方式 (ci-cd.md)](#cicd方式)

## Smallテンプレートの場合

Smallテンプレートでは、インフラ・セキュリティ・データ・運用のすべてを **`infrastructure.md`** 1ファイルに統合して記述する。
Fullでは5カテゴリ（インフラ・セキュリティ・データ・運用）が独立するが、Smallでは1ファイル内のセクションとしてまとめる。

### 推奨構成

```markdown
# インフラ・運用方式

## クラウド構成
{選定プロバイダ・主要サービス・構成概要}

## ネットワーク・セキュリティ
{ネットワーク構成の概要}
{認証方式（JWT等）・HTTPS・主要セキュリティ対策を簡潔に記述}

## データベース
{DB選定と選定理由・キャッシュ方針を簡潔に記述}

## CI/CD
{パイプライン概要・デプロイ方式}

## 監視・運用
{監視ツール・ログ方針・障害対応の概要}
```

### Fullとの主な差異

- インフラ（3ファイル）+ セキュリティ（4ファイル）+ データ（3ファイル）+ 運用（3ファイル）を1ファイルに統合
- 各セクションは要点のみを簡潔に記述（1セクションあたりテーブル1〜2個＋補足数行程度）
- セキュリティはネットワークセクションに統合し、認証方式・データ保護・主要対策に絞る
- データ方式はDB選定とキャッシュ方針の要約に留める
- 運用は監視ツール・ログ方針・DR概要に絞る
- 以下のインフラガイドの内容に加え、security-guide.md / data-guide.md / operations-guide.md の内容も参考にする

---

## 作成順序（Fullテンプレート）

cloud-architecture.md → network.md → ci-cd.md の順に作成する。
クラウド構成で基盤を定義し、ネットワークで通信経路を設計、CI/CDでデプロイメントパイプラインを構築する。

---

## クラウド構成

### クラウドプロバイダ選定に含める内容

**主要な選択肢:**

| プロバイダ | 強み | 考慮事項 |
|-----------|------|---------|
| AWS | サービス網羅性、実績 | コスト管理の複雑さ |
| GCP | データ分析・ML、Kubernetes | 日本リージョンの制約 |
| Azure | エンタープライズ連携、.NET親和性 | 学習曲線 |

**記載すべき項目:**
- 選定プロバイダと選定理由
- 利用するマネージドサービス一覧
- リージョン選定（レイテンシ、法規制）

### 構成図に含める内容

クラウド環境の全体構成をMermaid図で記載する。

**含めるべき要素:**
- VPC / サブネット構成
- コンピュートリソース（ECS / EKS / Lambda 等）
- データストア（RDS / DynamoDB / ElastiCache 等）
- ロードバランサー（ALB / NLB）
- CDN（CloudFront 等）
- ストレージ（S3 等）

### 環境構成に含める内容

| 環境 | 用途 | スペック | 備考 |
|------|------|--------|------|
| 開発（dev） | 開発・単体テスト | 最小構成 | 開発者ごとに用意可 |
| ステージング（stg） | 結合テスト・受入テスト | 本番同等 | 本番データのマスク版を利用 |
| 本番（prod） | 商用運用 | 性能要件準拠 | 冗長構成必須 |

### リソース設計に含める内容

**記載すべき項目:**
- インスタンスタイプ / サイズの選定根拠
- オートスケーリング方針（メトリクス、閾値、最小・最大台数）
- コスト見積もり概算（月額ベース）
- リザーブドインスタンス / Savings Plans の適用方針

### 品質基準

- 構成図が環境ごとに作成されていること（最低限本番環境）
- コスト意識のある設計であること（過剰スペック回避）
- 可用性要件（SLA）との整合性があること

---

## ネットワーク設計

### ネットワーク構成図に含める内容

**含めるべき要素:**
- VPCのCIDR設計
- パブリックサブネット / プライベートサブネットの分割
- AZ（アベイラビリティゾーン）の冗長構成
- NAT Gateway / Internet Gatewayの配置
- VPCエンドポイント（S3、DynamoDB等への内部通信）

### CDN設計に含める内容

**記載すべき項目:**
- CDNサービスの選定（CloudFront / Fastly 等）
- キャッシュ対象（静的アセット、画像、API応答等）
- キャッシュTTL方針
- オリジンサーバーとの接続方式
- カスタムドメイン・SSL証明書

**プロジェクト特性に応じた考慮事項の例:**
- 画像・メディアの配信最適化（リサイズ、WebP変換等）
- パーソナライズコンテンツのキャッシュ戦略
- トラフィックスパイク対策（セール、キャンペーン、メディア露出 等）

### DNS設計に含める内容

**記載すべき項目:**
- ドメイン構成（apex / サブドメイン）
- DNSサービス（Route 53 等）
- ヘルスチェック・フェイルオーバー設定
- TTL設定方針

### ロードバランサーに含める内容

**記載すべき項目:**
- LBの種類（ALB / NLB）と選定理由
- リスナー設定（HTTP/HTTPS、ポート）
- ターゲットグループの構成
- ヘルスチェック設定
- SSL/TLS終端の位置

### 品質基準

- セキュリティグループ / NACLの設計方針が明記されていること
- 通信経路のレイテンシが性能要件を満たすこと
- 単一障害点（SPOF）がないこと

---

## CI/CD方式

### CI/CDツール選定に含める内容

**主要な選択肢:**

| ツール | 特徴 | 適するケース |
|--------|------|-------------|
| GitHub Actions | GitHub統合、YAML定義 | GitHub利用プロジェクト |
| GitLab CI | GitLab統合、自前ランナー | セルフホスト要件あり |
| AWS CodePipeline | AWS統合、マネージド | AWSメインのプロジェクト |
| CircleCI | 高速ビルド、Docker親和性 | コンテナベース開発 |

### パイプライン構成に含める内容

**CIパイプライン（ビルド・テスト）:**

```
コード変更 → Lint/Format → ユニットテスト → ビルド → 静的解析 → セキュリティスキャン
```

**CDパイプライン（デプロイ）:**

```
ビルド成果物 → ステージングデプロイ → E2Eテスト → 承認 → 本番デプロイ → スモークテスト
```

**記載すべき項目:**
- 各ステージの実行内容と所要時間目標
- トリガー条件（プッシュ、PR、タグ等）
- 並列実行の方針
- キャッシュ戦略（依存パッケージ、ビルド成果物）

### デプロイ戦略に含める内容

**主要な選択肢:**

| 戦略 | 特徴 | リスク |
|------|------|--------|
| ローリングアップデート | 段階的入替、ダウンタイムなし | 新旧バージョン混在 |
| Blue/Green | 環境切替、即時ロールバック | リソースコスト2倍 |
| カナリア | 少数への段階リリース | モニタリング必須 |

**記載すべき項目:**
- 選定したデプロイ戦略と根拠
- ロールバック手順
- デプロイ頻度の目標

### 環境管理に含める内容

**記載すべき項目:**
- 環境変数・シークレットの管理方式（AWS Secrets Manager / SSM Parameter Store 等）
- Infrastructure as Code（Terraform / CloudFormation / CDK 等）の方針
- 環境間の設定差分管理

### 品質基準

- パイプラインの全ステージが定義されていること
- セキュリティスキャンが組み込まれていること
- ロールバック手順が明記されていること
- IaCの方針が決定されていること
