# API設計 作成ガイド

## 目次

1. [API設計方針 (api-overview.md)](#api設計方針)
2. [個別API仕様](#個別api仕様)

## Smallテンプレートの場合

Smallテンプレートでは、API設計方針と主要エンドポイント仕様を **`api-design.md`** 1ファイルに統合して記述する。

### 推奨構成

```markdown
# API設計

## 設計方針
{RESTful原則、認証方式、共通レスポンス形式、エラーレスポンス形式を簡潔に記述}

## エンドポイント一覧

| メソッド | パス | 概要 | 認証 |
|----------|------|------|------|
| POST | /api/auth/login | ログイン | 不要 |
| GET | /api/{resource} | 一覧取得 | 要 |
| ... | ... | ... | ... |

## 主要API仕様

### {API名1}（API-C-001）
- メソッド・パス: {POST /api/...}
- リクエスト: {パラメータ概要}
- レスポンス: {主要フィールド}
- ステータスコード: {200, 400, 401, 404, 500}

### {API名2}（API-C-002）
{同様の構成}
```

### Fullとの主な差異

- API設計方針と主要エンドポイントを1ファイルにまとめる
- エンドポイント一覧で全APIを俯瞰し、主要API（CRUD操作・認証等）のみ詳細仕様を記述
- リクエスト/レスポンスの詳細なスキーマ定義は省略可（主要フィールドの一覧で十分）
- ページネーション・フィルタリング等の共通仕様は設計方針セクションで簡潔に記述
- 以下の各セクション別ガイドの内容を参考にしつつ、小規模プロジェクトに必要十分な粒度でまとめる

---

## 作成順序（Fullテンプレート）

api-overview.md → 個別API仕様 の順に作成する。
API設計方針で全体の共通ルールを確定し、その後各APIの詳細仕様を定義する。
個別API仕様はドメイン単位で作成する。認証APIを最初に作成し、その後プロジェクトの主要ドメイン順に進める。

## 参照すべきドキュメント

- `docs/01-requirements/functional-requirements/` — 各機能の要件（APIで実現すべき機能）
- `docs/01-requirements/use-cases/` — ユースケース（APIの利用シナリオ）
- `docs/02-technical-design/architecture/architecture-pattern.md` — 通信パターン（REST等）
- `docs/02-technical-design/security/authentication.md` — 認証方式（JWT等）
- `docs/02-technical-design/security/authorization.md` — 認可方式（RBAC等）
- `docs/03-basic-design/data-model/` — データモデル（リソース構造の根拠）
- `docs/03-basic-design/screen-design/` — 画面設計（APIの呼び出し元）

---

## API設計方針

### 設計原則に含める内容

RESTful APIの設計原則と本プロジェクトでの適用方針を記載する。

**記載すべき項目:**

- **リソース指向設計** — URLはリソース（名詞）を表す
- **HTTPメソッドの使い分け**

| メソッド | 用途 | 冪等性 | 安全性 |
|---------|------|--------|--------|
| GET | リソース取得 | 冪等 | 安全 |
| POST | リソース作成 | 非冪等 | 非安全 |
| PUT | リソース全体更新 | 冪等 | 非安全 |
| PATCH | リソース部分更新 | 非冪等 | 非安全 |
| DELETE | リソース削除 | 冪等 | 非安全 |

- **URL命名規則**
  - ベースパス: `/api/v1/`
  - リソース名: 複数形、小文字、ケバブケース
  - 例: `/api/v1/products`, `/api/v1/order-items`
  - ネスト: 最大2階層（例: `/api/v1/products/{id}/reviews`）

- **バージョニング方針**
  - URLパスにバージョンを含める（`/api/v1/`）
  - メジャーバージョンのみ管理

### 共通仕様に含める内容

#### 認証ヘッダー

```
Authorization: Bearer <JWT token>
```

- 認証不要のエンドポイントを明示する
- 管理者APIは追加の権限チェックを行う

#### リクエスト共通仕様

- Content-Type: `application/json`
- 文字コード: UTF-8
- 日時フォーマット: ISO 8601（`2024-01-01T00:00:00Z`）

#### ページネーション

```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 150,
    "total_pages": 8
  }
}
```

- クエリパラメータ: `?page=1&per_page=20`
- デフォルト: 20件/ページ
- 最大: 100件/ページ

#### ソート

- クエリパラメータ: `?sort=created_at&order=desc`
- デフォルト: 作成日時の降順

#### フィルタリング

- クエリパラメータ: `?status=active&category_id=1`
- 検索: `?q=keyword`

#### レスポンス形式

**成功レスポンス（単一リソース）:**

```json
{
  "data": {
    "id": "uuid",
    "type": "product",
    "attributes": { ... }
  }
}
```

**成功レスポンス（コレクション）:**

```json
{
  "data": [ ... ],
  "pagination": { ... }
}
```

#### エラーレスポンス形式

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値が不正です",
    "details": [
      {
        "field": "email",
        "message": "メールアドレスの形式が不正です"
      }
    ]
  }
}
```

#### HTTPステータスコード

| コード | 意味 | 使用場面 |
|--------|------|---------|
| 200 | OK | 取得・更新成功 |
| 201 | Created | 作成成功 |
| 204 | No Content | 削除成功 |
| 400 | Bad Request | バリデーションエラー |
| 401 | Unauthorized | 未認証 |
| 403 | Forbidden | 権限不足 |
| 404 | Not Found | リソース未存在 |
| 409 | Conflict | 競合（重複登録等） |
| 422 | Unprocessable Entity | ビジネスロジックエラー |
| 429 | Too Many Requests | レート制限超過 |
| 500 | Internal Server Error | サーバー内部エラー |

#### レート制限

| 対象 | 制限 | 備考 |
|------|------|------|
| 認証API | 10回/分/IP | ブルートフォース対策 |
| 一般API（認証済） | 100回/分/ユーザー | — |
| 一般API（未認証） | 30回/分/IP | — |
| 管理者API | 200回/分/ユーザー | — |

### エンドポイント一覧に含める内容

全APIエンドポイントを一覧化する。

※ 以下は記載例。プロジェクトのAPIに応じて置き換えること。

| No | メソッド | パス | 説明 | 認証 | 権限 |
|----|---------|------|------|------|------|
| 1 | POST | /api/v1/auth/register | ユーザー登録 | 不要 | — |
| 2 | POST | /api/v1/auth/login | ログイン | 不要 | — |
| 3 | GET | /api/v1/{resources} | リソース一覧取得 | 不要 | — |
| 4 | GET | /api/v1/{resources}/{id} | リソース詳細取得 | 不要 | — |

### 品質基準

- 命名規則が一貫していること
- エラーレスポンスの形式が統一されていること
- 認証・認可の方針が方式設計と整合していること

---

## 個別API仕様

### 各API仕様ファイルに含める内容

APIのドメイン単位でファイルを作成する。ドメイン分割はプロジェクトの機能要件に応じて決定する。

#### エンドポイント一覧

ファイル先頭にそのドメインのエンドポイント一覧をテーブルで記載する。

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/v1/auth/register | 会員登録 | 不要 |
| POST | /api/v1/auth/login | ログイン | 不要 |

#### 各エンドポイント詳細

エンドポイントごとに以下を記載する。

**記載フォーマット:**

```markdown
### POST /api/v1/auth/register

会員登録を行う。

#### リクエスト

**ヘッダー:**

| ヘッダー名 | 値 | 必須 |
|-----------|-----|------|
| Content-Type | application/json | 必須 |

**パスパラメータ:**

（該当する場合のみ）

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string (UUID) | 必須 | リソースID |

**クエリパラメータ:**

（該当する場合のみ）

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| page | integer | 任意 | 1 | ページ番号 |

**リクエストボディ:**

| フィールド | 型 | 必須 | バリデーション | 説明 |
|-----------|-----|------|--------------|------|
| email | string | 必須 | メール形式、255文字以内 | メールアドレス |
| password | string | 必須 | 8文字以上、英数記号 | パスワード |

**リクエスト例:**

\```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
\```

#### レスポンス

**成功（201 Created）:**

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | string (UUID) | ユーザーID |
| email | string | メールアドレス |
| created_at | string (ISO 8601) | 作成日時 |

**レスポンス例:**

\```json
{
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
\```

**エラー:**

| ステータス | エラーコード | 条件 |
|-----------|------------|------|
| 400 | VALIDATION_ERROR | バリデーション失敗 |
| 409 | EMAIL_ALREADY_EXISTS | メールアドレス重複 |
```

#### 画面との対応

各APIが呼び出される画面とアクションを明記する。

| 画面 | アクション | 備考 |
|------|----------|------|
| （例）会員登録画面 | 登録ボタンクリック | フォームバリデーション後 |

### 品質基準

- 画面設計のすべての画面アクションに対応するAPIが存在すること
- リクエスト・レスポンスのフィールドがデータモデルと整合していること
- すべてのエラーケースが定義されていること
- バリデーションルールが画面設計の入力バリデーションと一致していること
